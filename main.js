/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var B=Object.defineProperty;var D=Object.getOwnPropertyDescriptor;var R=Object.getOwnPropertyNames;var W=Object.prototype.hasOwnProperty;var q=(w,h)=>{for(var e in h)B(w,e,{get:h[e],enumerable:!0})},V=(w,h,e,t)=>{if(h&&typeof h=="object"||typeof h=="function")for(let i of R(h))!W.call(w,i)&&i!==e&&B(w,i,{get:()=>h[i],enumerable:!(t=D(h,i))||t.enumerable});return w};var z=w=>V(B({},"__esModule",{value:!0}),w);var Y={};q(Y,{default:()=>I});module.exports=z(Y);var o=require("obsidian"),j={autoOpen:!1,ignoredFolders:".git, .obsidian, node_modules",ignoredExtensions:"png, jpg, jpeg, gif, svg, pdf, mp3, mp4, zip",customFolderIcon:"folder",customFileIcon:"document",activeFolderShadow:"0 0 8px rgba(0, 0, 0, 0.3)",folderNameMaxWidth:150,folderPaneWidth:250,defaultSortCriteria:"mtime",defaultSortOrder:"desc",customCommands:[],showFolderToggleIcon:!0,fileNamingMethod:"manual",countedFileTypes:"md,pdf,epub"},v="file-manager-view",I=class extends o.Plugin{async confirmDelete(e){return new Promise(t=>{new M(this.app,e+`

\u6587\u4EF6\u5C06\u88AB\u79FB\u52A8\u5230\u7CFB\u7EDF\u56DE\u6536\u7AD9\uFF0C\u53EF\u4EE5\u5728\u9700\u8981\u65F6\u6062\u590D\u3002`,()=>t(!0),()=>t(!1)).open()})}async onload(){await this.loadSettings(),this.addCommand({id:"reload-file-tree",name:"\u91CD\u8F7D\u6587\u4EF6\u6811",callback:()=>{this.app.workspace.getLeavesOfType(v).forEach(t=>{t.view instanceof C&&(t.view.initFolderTree(),new o.Notice("\u6587\u4EF6\u6811\u5DF2\u91CD\u8F7D"))})}}),this.loadStyles(),this.registerView(v,e=>new C(e,this)),this.addRibbonIcon("folder","\u6587\u4EF6\u7BA1\u7406\u5668",()=>{this.activateView()}),this.addSettingTab(new P(this.app,this)),this.settings.autoOpen&&this.app.workspace.onLayoutReady(()=>this.activateView())}loadStyles(){let e=document.createElement("style");fetch("app://local/d:/code/obsidian-plugin/\u6587\u4EF6\u7BA1\u7406\u5668/v0.3 - \u4E0B\u65B9\u5DE5\u5177\u680F\u4E4B\u524D/styles.css").then(t=>t.text()).then(t=>{e.textContent=t,document.head.appendChild(e)}),this.register(()=>e.remove())}addStyle(e){let t=document.createElement("style");t.textContent=e,document.head.appendChild(t),this.register(()=>t.remove())}async onunload(){this.app.workspace.detachLeavesOfType(v)}async loadSettings(){this.settings=Object.assign({},j,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async activateView(){let e=this.app.workspace.getLeavesOfType(v);if(e.length>0){this.app.workspace.revealLeaf(e[0]);return}let t=this.app.workspace.getLeftLeaf(!1);t&&await t.setViewState({type:v,active:!0})}},C=class extends o.ItemView{constructor(e,t){super(e);this.selectedFiles=[];this.lastSelectedFile=null;this.plugin=t,this.currentSortCriteria=this.plugin.settings.defaultSortCriteria,this.currentSortOrder=this.plugin.settings.defaultSortOrder}generateAutoFileName(){let e=new Date,t=e.getFullYear(),i=String(e.getMonth()+1).padStart(2,"0"),n=String(e.getDate()).padStart(2,"0"),s=String(e.getHours()).padStart(2,"0"),a=String(e.getMinutes()).padStart(2,"0"),r=String(e.getSeconds()).padStart(2,"0");return`${t}-${i}-${n}-${s}${a}${r}`}async createMarkdownFile(e){if(e){if(this.plugin.settings.fileNamingMethod==="auto"){let t=this.generateAutoFileName()+".md";try{let i=await this.app.vault.create(`${e.path}/${t}`,"");return await this.app.workspace.getLeaf().openFile(i),this.showFolderFiles(e),this.highlightOpenedFile(i),new o.Notice(`\u5DF2\u521B\u5EFA\u5E76\u6253\u5F00\u6587\u4EF6: ${t}`),i}catch(i){return new o.Notice(`\u521B\u5EFA\u6587\u4EF6\u5931\u8D25: ${i.message}`),null}}else{let t=await this.promptForName("\u65B0\u6587\u4EF6\u540D\u79F0");if(t)try{let i=t.endsWith(".md")?t:`${t}.md`,n=await this.app.vault.create(`${e.path}/${i}`,"");return await this.app.workspace.getLeaf().openFile(n),this.showFolderFiles(e),this.highlightOpenedFile(n),new o.Notice(`\u5DF2\u521B\u5EFA\u5E76\u6253\u5F00\u6587\u4EF6: ${i}`),n}catch(i){return new o.Notice(`\u521B\u5EFA\u6587\u4EF6\u5931\u8D25: ${i.message}`),null}}return null}}getViewType(){return v}getDisplayText(){return"\u6587\u4EF6\u7BA1\u7406\u5668"}getIcon(){return"folder"}async moveFilesToFolder(e,t){if(!e.length||!t){new o.Notice("\u65E0\u6548\u7684\u6587\u4EF6\u6216\u76EE\u6807\u6587\u4EF6\u5939");return}let i=e.length,n=0,s=0;for(let a of e)try{if(!this.app.vault.getAbstractFileByPath(a.path))throw new Error(`\u6E90\u6587\u4EF6\u4E0D\u5B58\u5728: ${a.name}`);let r=t.path?`${t.path}/${a.name}`:a.name;if(this.app.vault.getAbstractFileByPath(r))throw new Error(`\u76EE\u6807\u6587\u4EF6\u5939\u5DF2\u5B58\u5728\u540C\u540D\u6587\u4EF6: ${a.name}`);if(a.parent&&a.parent.path===t.path)throw new Error(`\u6587\u4EF6\u5DF2\u5728\u76EE\u6807\u6587\u4EF6\u5939\u4E2D: ${a.name}`);if(a.path.startsWith(t.path+"/"))throw new Error(`\u4E0D\u80FD\u5C06\u6587\u4EF6\u79FB\u52A8\u5230\u5176\u5B50\u6587\u4EF6\u5939\u4E2D: ${a.name}`);await this.app.fileManager.renameFile(a,r),n++}catch(r){console.error(`\u79FB\u52A8\u6587\u4EF6 ${a.name} \u5931\u8D25:`,r),s++,new o.Notice(`\u79FB\u52A8\u6587\u4EF6 ${a.name} \u5931\u8D25: ${r.message}`)}this.selectedFiles=[],this.updateDeleteButton(),this.currentFolder&&this.showFolderFiles(this.currentFolder),n>0&&new o.Notice(`\u5DF2\u6210\u529F\u79FB\u52A8 ${n} \u4E2A\u6587\u4EF6\u5230 ${t.name}`),s>0&&new o.Notice(`${s} \u4E2A\u6587\u4EF6\u79FB\u52A8\u5931\u8D25`,5e3)}async onOpen(){let e=this.containerEl.children[1];e.empty(),e.addClass("file-manager-container");let t=e.createEl("div",{cls:"file-manager-toolbar"});this.searchInput=t.createEl("input",{cls:"file-manager-search",attr:{type:"text",placeholder:"\u641C\u7D22\u6587\u4EF6..."}}),this.searchInput.addEventListener("input",()=>this.handleSearch()),this.sortButton=t.createEl("button",{cls:"file-manager-sort-btn",text:"\u6392\u5E8F"}),this.sortButton.addEventListener("click",()=>this.showSortMenu()),this.deleteButton=t.createEl("button",{cls:"file-manager-delete-btn",text:"\u5220\u9664\u6240\u9009"}),this.deleteButton.style.display="none",this.deleteButton.style.backgroundColor="var(--background-modifier-error)",this.deleteButton.style.color="var(--text-on-accent)",this.deleteButton.addEventListener("click",()=>this.deleteSelectedFiles());let i=t.createEl("button",{cls:"file-manager-move-btn",text:"\u79FB\u52A8\u6240\u9009"});i.style.display="none",i.addEventListener("click",()=>{this.currentFolder?this.showFolderSelectionModal(this.currentFolder,async l=>{l&&await this.moveFilesToFolder(this.selectedFiles,l)}):new o.Notice("\u8BF7\u5148\u9009\u62E9\u4E00\u4E2A\u6587\u4EF6\u5939")}),t.createEl("button",{cls:"file-manager-new-note-btn",text:"+\u6587\u6863"}).addEventListener("click",()=>this.createNewNote()),t.createEl("button",{cls:"file-manager-root-create-btn",text:"+\u6587\u4EF6\u5939"}).addEventListener("click",l=>this.createRootFolder()),t.createEl("button",{cls:"file-manager-collapse-btn",text:"\u6298\u53E0"}).addEventListener("click",()=>this.collapseAllFolders()),t.createEl("button",{cls:"file-manager-expand-btn",text:"\u5C55\u5F00"}).addEventListener("click",()=>this.expandAllFolders());let d=e.createEl("div",{cls:"file-manager-content"});this.folderContainer=d.createEl("div",{cls:"file-manager-folders"}),this.folderContainer.style.minWidth="150px",this.folderContainer.style.width=`${this.plugin.settings.folderPaneWidth}px`,this.folderContainer.style.flexShrink="0",this.folderContainer.addEventListener("click",l=>{l.target===this.folderContainer&&this.showRootFiles()}),this.resizer=d.createEl("div",{cls:"file-manager-resizer"}),this.setupResizer(),this.fileContainer=d.createEl("div",{cls:"file-manager-files"}),this.fileContainer.style.flex="1",this.fileContainer.style.overflow="auto",this.initFolderTree(),this.registerFileSystemEvents(),this.registerEvent(this.app.workspace.on("file-open",l=>{l&&this.focusOnFile(l)}))}async deleteSelectedFiles(){if(this.selectedFiles.length===0)return;if(await this.plugin.confirmDelete(`\u786E\u5B9A\u8981\u5220\u9664\u9009\u4E2D\u7684 ${this.selectedFiles.length} \u4E2A\u6587\u4EF6\u5417\uFF1F`))try{for(let t of this.selectedFiles)await this.app.vault.trash(t,!0);new o.Notice(`\u5DF2\u5C06 ${this.selectedFiles.length} \u4E2A\u6587\u4EF6\u79FB\u52A8\u5230\u56DE\u6536\u7AD9`),this.selectedFiles=[],this.updateDeleteButton(),this.showFolderFiles(this.currentFolder)}catch(t){new o.Notice(`\u5220\u9664\u6587\u4EF6\u5931\u8D25: ${t.message}`)}}showRootFiles(){let e=this.app.vault.getRoot();this.currentFolder=e,this.fileContainer.empty();let t=this.fileContainer.createEl("div",{cls:"file-manager-file-header"});t.textContent="\u6839\u76EE\u5F55\u6587\u4EF6";let i=e.children.filter(s=>s instanceof o.TFile&&!this.isIgnoredFile(s.path));this.sortFilesArray(i,this.currentSortCriteria,this.currentSortOrder);let n=this.fileContainer.createEl("div",{cls:"file-manager-file-list"});if(n.addEventListener("dragover",s=>{s.preventDefault(),n.addClass("file-manager-drag-over")}),n.addEventListener("dragleave",()=>{n.removeClass("file-manager-drag-over")}),n.addEventListener("drop",async s=>{var r;s.preventDefault(),n.removeClass("file-manager-drag-over");let a=(r=s.dataTransfer)==null?void 0:r.getData("text/plain");if(a&&a.startsWith("folder:")){let d=a.substring(7),l=this.app.vault.getAbstractFileByPath(d);if(l instanceof o.TFolder&&l.path!==e.path)try{await this.app.fileManager.renameFile(l,l.name),this.initFolderTree(),new o.Notice(`\u5DF2\u79FB\u52A8\u6587\u4EF6\u5939 ${l.name} \u5230\u6839\u76EE\u5F55`),this.showRootFiles()}catch(m){new o.Notice(`\u79FB\u52A8\u6587\u4EF6\u5939\u5931\u8D25: ${m.message}`)}}}),i.length===0){let s=n.createEl("div",{cls:"file-manager-empty-message"});s.textContent="\u6839\u76EE\u5F55\u4E0B\u6CA1\u6709\u6587\u4EF6",s.style.padding="20px",s.style.textAlign="center",s.style.color="var(--text-muted)"}else i.forEach(s=>{this.createFileElement(s,n)});document.querySelectorAll(".file-manager-folder-title").forEach(s=>{s.removeClass("file-manager-folder-active"),s.style.boxShadow="none"})}updateDeleteButton(){let e=this.selectedFiles.length>1;this.deleteButton.style.display=e?"inline-block":"none";let t=this.containerEl.querySelector(".file-manager-move-btn");t&&(t.style.display=e?"inline-block":"none")}setupResizer(){let e=0,t=0,i=a=>{e=a.clientX,t=this.folderContainer.offsetWidth,document.addEventListener("mousemove",n),document.addEventListener("mouseup",s),a.preventDefault()},n=a=>{let r=t+(a.clientX-e);r>150&&r<500&&(this.folderContainer.style.width=r+"px",this.updateFolderNameStyles(),this.plugin.settings.folderPaneWidth=r)},s=()=>{document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",s),this.plugin.saveSettings()};this.resizer.addEventListener("mousedown",i)}updateFolderNameStyles(){this.folderContainer.querySelectorAll(".file-manager-folder-name").forEach(t=>{t.style.maxWidth=`${this.plugin.settings.folderNameMaxWidth}px`})}registerFileSystemEvents(){this.registerEvent(this.app.vault.on("create",e=>{this.updateFileStats(),this.currentFolder&&this.showFolderFiles(this.currentFolder)})),this.registerEvent(this.app.vault.on("delete",e=>{this.updateFileStats(),e instanceof o.TFolder&&this.currentFolder&&e.path===this.currentFolder.path?e.parent&&(this.currentFolder=e.parent,this.showFolderFiles(this.currentFolder)):this.currentFolder&&this.showFolderFiles(this.currentFolder),e instanceof o.TFolder&&this.initFolderTree()})),this.registerEvent(this.app.vault.on("rename",(e,t)=>{this.updateFileStats(),this.currentFolder&&this.showFolderFiles(this.currentFolder),e instanceof o.TFolder&&this.initFolderTree()})),this.registerInterval(window.setInterval(()=>{this.currentFolder&&(this.app.vault.getAbstractFileByPath(this.currentFolder.path)||(this.currentFolder=this.app.vault.getRoot(),this.showFolderFiles(this.currentFolder)))},3e4))}updateFileStats(){this.folderContainer.querySelectorAll(".file-manager-file-count").forEach(t=>{let i=t.closest(".file-manager-folder");if(i){let n=i.querySelector(".file-manager-folder-title");if(n){let s=n.getAttribute("data-path");if(s){let a=this.app.vault.getAbstractFileByPath(s);if(a instanceof o.TFolder){let r=this.countFiles(a);t.textContent=`(${r})`}}}}})}async onClose(){}initFolderTree(){this.folderContainer.empty(),[...this.app.vault.getRoot().children].sort((i,n)=>i instanceof o.TFolder&&!(n instanceof o.TFolder)?-1:!(i instanceof o.TFolder)&&n instanceof o.TFolder?1:this.naturalSort(i.name,n.name)).forEach(i=>{i instanceof o.TFolder&&!this.isIgnoredFolder(i.path)&&this.createFolderElement(i,this.folderContainer)})}createFolderElement(e,t){let i=t.createEl("div",{cls:"file-manager-folder"});i.setAttribute("draggable","true"),i.setAttribute("data-path",e.path);let n=i.createEl("div",{cls:"file-manager-folder-title"});n.setAttribute("data-path",e.path);let s=n.createEl("span",{cls:"file-manager-collapse-icon"});this.plugin.settings.showFolderToggleIcon||(s.style.display="none"),s.innerHTML="\u25B6";let a=n.createEl("span",{cls:"file-manager-folder-icon"});a.innerHTML="\u{1F4C1}";let r=n.createEl("span",{cls:"file-manager-folder-name"});r.textContent=e.name,r.style.maxWidth=`${this.plugin.settings.folderNameMaxWidth}px`,r.style.overflow="hidden",r.style.textOverflow="ellipsis",r.style.whiteSpace="nowrap";let d=n.createEl("span",{cls:"file-manager-file-count"}),l=this.countFiles(e);d.textContent=`(${l})`;let m=i.createEl("div",{cls:"file-manager-folder-children",attr:{style:"display: none;"}});n.addEventListener("click",c=>{m.style.display==="none"?(m.style.display="block",s.innerHTML="\u25BC",this.loadFolderContents(e)):(m.style.display="none",s.innerHTML="\u25B6"),this.showFolderFiles(e),this.updateActiveFolderStyle(e,n),c.stopPropagation()});let p=null;i.addEventListener("dragover",c=>{c.preventDefault(),i.addClass("file-manager-drag-over"),!p&&m.style.display==="none"&&(p=window.setTimeout(()=>{m.style.display="block",s.innerHTML="\u25BC",this.loadFolderContents(e),p=null},500))}),i.addEventListener("dragleave",()=>{i.removeClass("file-manager-drag-over"),p&&(clearTimeout(p),p=null)}),i.addEventListener("drop",async c=>{var y;if(c.preventDefault(),i.removeClass("file-manager-drag-over"),p&&(clearTimeout(p),p=null),this.selectedFiles.length>0){await this.moveFilesToFolder(this.selectedFiles,e);return}let u=(y=c.dataTransfer)==null?void 0:y.getData("text/plain");if(u&&u.startsWith("folder:")){let E=u.substring(7),F=this.app.vault.getAbstractFileByPath(E);if(F instanceof o.TFolder&&F.path!==e.path)try{if(e.path.startsWith(F.path+"/"))new o.Notice("\u4E0D\u80FD\u5C06\u6587\u4EF6\u5939\u79FB\u52A8\u5230\u5176\u5B50\u6587\u4EF6\u5939\u4E2D");else{let g=e.path?`${e.path}/${F.name}`:F.name,b=this.app.workspace.getLeavesOfType("markdown"),k=[];if(b.forEach(x=>{let T=x.view.file;T&&T.path.startsWith(F.path+"/")&&k.push(T)}),k.length>0){new o.Notice("\u6B63\u5728\u5173\u95ED\u6E90\u6587\u4EF6\u5939\u4E2D\u7684\u6253\u5F00\u6587\u4EF6\u4EE5\u5B8C\u6210\u79FB\u52A8...");for(let x of b){let T=x.view.file;T&&k.includes(T)&&x.detach()}}await this.app.fileManager.renameFile(F,g),this.initFolderTree(),this.currentFolder&&this.currentFolder.path===e.path&&this.showFolderFiles(e),new o.Notice(`\u5DF2\u79FB\u52A8\u6587\u4EF6\u5939 ${F.name} \u5230 ${e.name}`),k.length>0&&setTimeout(async()=>{for(let x of k){let A=x.path.replace(F.path,g),T=this.app.vault.getAbstractFileByPath(A);T instanceof o.TFile&&await this.app.workspace.getLeaf().openFile(T)}},500)}}catch(g){new o.Notice(`\u79FB\u52A8\u6587\u4EF6\u5939\u5931\u8D25: ${g.message}`),console.error("\u79FB\u52A8\u6587\u4EF6\u5939\u9519\u8BEF:",g)}}}),n.addEventListener("contextmenu",c=>{this.showFolderContextMenu(c,e),c.preventDefault(),c.stopPropagation()}),i.addEventListener("dragstart",c=>{c.stopPropagation(),c.dataTransfer&&(c.dataTransfer.setData("text/plain","folder:"+e.path),c.dataTransfer.effectAllowed="move"),i.addClass("file-manager-dragging")}),i.addEventListener("dragend",()=>{i.removeClass("file-manager-dragging")}),[...e.children].sort((c,u)=>c instanceof o.TFolder&&!(u instanceof o.TFolder)?-1:!(c instanceof o.TFolder)&&u instanceof o.TFolder?1:c.name.localeCompare(u.name,"zh-CN")).forEach(c=>{c instanceof o.TFolder&&!this.isIgnoredFolder(c.path)&&this.createFolderElement(c,m)})}updateActiveFolderStyle(e,t){document.querySelectorAll(".file-manager-folder-title").forEach(i=>{i.removeClass("file-manager-folder-active"),i.style.boxShadow="none"}),this.currentFolder=e,t.addClass("file-manager-folder-active")}expandFolderRecursively(e){var i;let t=this.folderContainer.querySelector(`.file-manager-folder-title[data-path="${e.path}"]`);if(t){let n=(i=t.parentElement)==null?void 0:i.querySelector(".file-manager-folder-children"),s=t.querySelector(".file-manager-collapse-icon");n&&s&&(n.style.display="block",s.innerHTML="\u25BC",this.loadFolderContents(e),e.children.forEach(a=>{a instanceof o.TFolder&&!this.isIgnoredFolder(a.path)&&this.expandFolderRecursively(a)}))}}loadFolderContents(e){}showFolderFiles(e){this.fileContainer.empty();let t=this.fileContainer.createEl("div",{cls:"file-manager-file-header"});t.textContent=`${e.name} \u4E2D\u7684\u6587\u4EF6`;let i=e.children.filter(s=>s instanceof o.TFile&&!this.isIgnoredFile(s.path));this.sortFilesArray(i,this.currentSortCriteria,this.currentSortOrder);let n=this.fileContainer.createEl("div",{cls:"file-manager-file-list"});n.addEventListener("dragover",s=>{s.preventDefault(),n.addClass("file-manager-drag-over")}),n.addEventListener("dragleave",()=>{n.removeClass("file-manager-drag-over")}),n.addEventListener("drop",async s=>{var r;s.preventDefault(),n.removeClass("file-manager-drag-over");let a=(r=s.dataTransfer)==null?void 0:r.getData("text/plain");if(a&&a.startsWith("folder:")){let d=a.substring(7),l=this.app.vault.getAbstractFileByPath(d);if(l instanceof o.TFolder&&l.path!==e.path)try{e.path.startsWith(l.path+"/")?new o.Notice("\u4E0D\u80FD\u5C06\u6587\u4EF6\u5939\u79FB\u52A8\u5230\u5176\u5B50\u6587\u4EF6\u5939\u4E2D"):(await this.app.fileManager.renameFile(l,`${e.path}/${l.name}`),this.initFolderTree(),new o.Notice(`\u5DF2\u79FB\u52A8\u6587\u4EF6\u5939 ${l.name} \u5230 ${e.name}`))}catch(m){new o.Notice(`\u79FB\u52A8\u6587\u4EF6\u5939\u5931\u8D25: ${m.message}`)}}}),i.forEach(s=>{this.createFileElement(s,n)})}showFolderSelectionModal(e,t){new O(this.app,e,t).open()}createFileElement(e,t){var m,p;let i=t.createEl("div",{cls:"file-manager-file"});i.setAttribute("draggable","true"),i.setAttribute("data-path",e.path);let n=i.createEl("div",{cls:"file-manager-file-main"}),s=n.createEl("div",{cls:"file-manager-filename-row"}),a=s.createEl("span",{cls:"file-manager-file-icon"});a.innerHTML=this.getFileIcon(e);let r=s.createEl("span",{cls:"file-manager-file-name"});r.textContent=e.name,r.style.maxWidth="calc(100% - 30px)",r.style.overflow="hidden",r.style.textOverflow="ellipsis",r.style.whiteSpace="nowrap",r.style.display="inline-block";let l=new Date(e.stat.mtime).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"});if(r.setAttribute("title",`${e.name}
\u4FEE\u6539\u65F6\u95F4\uFF1A${l}`),e.extension==="md"){let f=n.createEl("div",{cls:"file-manager-file-tags"}),c=this.app.metadataCache.getFileCache(e),u=((m=c==null?void 0:c.frontmatter)==null?void 0:m.tags)||[],y=((p=c==null?void 0:c.tags)==null?void 0:p.map(g=>g.tag))||[],E=Array.from(new Set([...u,...y])),F=E.slice(0,3);E.length>3&&f.createEl("span",{cls:"file-manager-tag",text:`+${E.length-3}`}).setAttribute("title",E.join(", ")),F.forEach(g=>{let b=f.createEl("span",{cls:"file-manager-tag",text:g})})}i.addEventListener("click",f=>{if(f.shiftKey&&this.lastSelectedFile){let c=Array.from(t.querySelectorAll(".file-manager-file")),u=c.findIndex(g=>g.getAttribute("data-path")===e.path),y=c.findIndex(g=>{var b;return g.getAttribute("data-path")===((b=this.lastSelectedFile)==null?void 0:b.path)});if(y===-1)return;let E=Math.min(u,y),F=Math.max(u,y);document.querySelectorAll(".file-manager-selected").forEach(g=>{g.removeClass("file-manager-selected")}),this.selectedFiles=[];for(let g=E;g<=F;g++){let b=c[g];b.addClass("file-manager-selected");let k=b.getAttribute("data-path");if(k){let x=this.app.vault.getAbstractFileByPath(k);x instanceof o.TFile&&this.selectedFiles.push(x)}}}else f.ctrlKey?(this.selectedFiles.includes(e)?(this.selectedFiles=this.selectedFiles.filter(c=>c!==e),i.removeClass("file-manager-selected")):(this.selectedFiles.push(e),i.addClass("file-manager-selected")),this.lastSelectedFile=e):(document.querySelectorAll(".file-manager-selected").forEach(c=>{c.removeClass("file-manager-selected")}),this.selectedFiles=[e],this.lastSelectedFile=e,this.app.workspace.getLeaf().openFile(e));this.updateDeleteButton()}),i.addEventListener("contextmenu",f=>{this.showFileContextMenu(f,e),f.preventDefault()}),i.addEventListener("dragstart",f=>{this.selectedFiles.includes(e)||(document.querySelectorAll(".file-manager-selected").forEach(c=>{c.removeClass("file-manager-selected")}),this.selectedFiles=[e],i.addClass("file-manager-selected")),f.dataTransfer&&(f.dataTransfer.setData("text/plain",e.path),f.dataTransfer.effectAllowed="move")})}highlightOpenedFile(e){setTimeout(()=>{this.fileContainer.querySelectorAll(".file-manager-file").forEach(i=>{let n=i.querySelector(".file-manager-file-name");n&&n.textContent===e.name&&(document.querySelectorAll(".file-manager-selected").forEach(s=>{s.removeClass("file-manager-selected")}),i.addClass("file-manager-selected"),i.scrollIntoView({behavior:"smooth",block:"center"}),this.selectedFiles=[e])})},100)}showFolderContextMenu(e,t){let i=new L(this.app);i.addItem(n=>{n.setTitle("\u65B0\u5EFA\u6587\u4EF6\u5939").setIcon("folder-plus").onClick(async()=>{var a;let s=await this.promptForName("\u65B0\u6587\u4EF6\u5939\u540D\u79F0");if(s)try{if(s.match(/[\\/:*?"<>|]/))throw new Error('\u6587\u4EF6\u5939\u540D\u79F0\u4E0D\u80FD\u5305\u542B\u4EE5\u4E0B\u5B57\u7B26: \\ / : * ? " < > |');let r=`${t.path}/${s}`;if(this.app.vault.getAbstractFileByPath(r))throw new Error("\u5DF2\u5B58\u5728\u540C\u540D\u6587\u4EF6\u5939\u6216\u6587\u4EF6");await this.app.vault.createFolder(r),this.initFolderTree(),this.currentFolder&&this.currentFolder.path===t.path&&this.showFolderFiles(t);let d=this.folderContainer.querySelector(`.file-manager-folder-title[data-path="${t.path}"]`);if(d){let l=(a=d.parentElement)==null?void 0:a.querySelector(".file-manager-folder-children"),m=d.querySelector(".file-manager-collapse-icon");l&&m&&(l.style.display="block",m.innerHTML="\u25BC")}new o.Notice(`\u5DF2\u521B\u5EFA\u6587\u4EF6\u5939: ${s}`)}catch(r){new o.Notice(`\u521B\u5EFA\u6587\u4EF6\u5939\u5931\u8D25: ${r.message}`),console.error("\u521B\u5EFA\u6587\u4EF6\u5939\u9519\u8BEF:",r)}})}),i.addItem(n=>{n.setTitle("\u5168\u90E8\u5C55\u5F00\u5F53\u524D\u6587\u4EF6\u5939").setIcon("folder-open").onClick(()=>{this.expandFolderRecursively(t),new o.Notice(`\u5DF2\u5C55\u5F00\u6587\u4EF6\u5939: ${t.name}`)})}),i.addItem(n=>{n.setTitle("\u65B0\u5EFA Markdown \u6587\u4EF6").setIcon("file-plus").onClick(async()=>{await this.createMarkdownFile(t)})}),this.addPluginCreateOptions(new L(this.app),t),this.addNativeFileManagerOptions(i,t),this.plugin.settings.customCommands&&this.plugin.settings.customCommands.length>0&&(i.addSeparator(),this.plugin.settings.customCommands.forEach(n=>{i.addItem(s=>{s.setTitle(n.name).setIcon(n.icon).onClick(()=>{this.executeCustomCommand(n,t)})})})),i.addItem(n=>{n.setTitle("\u91CD\u547D\u540D").setIcon("pencil").onClick(async()=>{let s=await this.promptForName("\u91CD\u547D\u540D\u6587\u4EF6\u5939",t.name);if(s&&s!==t.name)try{let a=t.parent?t.parent.path+"/":"";await this.app.fileManager.renameFile(t,`${a}${s}`),this.initFolderTree(),new o.Notice(`\u5DF2\u91CD\u547D\u540D\u6587\u4EF6\u5939\u4E3A: ${s}`)}catch(a){new o.Notice(`\u91CD\u547D\u540D\u5931\u8D25: ${a.message}`)}})}),i.addItem(n=>{n.setTitle("\u5220\u9664").setIcon("trash").onClick(async()=>{if(await this.confirmDelete(`\u786E\u5B9A\u8981\u5220\u9664\u6587\u4EF6\u5939 "${t.name}" \u53CA\u5176\u6240\u6709\u5185\u5BB9\u5417\uFF1F`))try{await this.app.vault.trash(t,!0),this.initFolderTree(),new o.Notice(`\u5DF2\u5C06\u6587\u4EF6\u5939\u79FB\u52A8\u5230\u56DE\u6536\u7AD9: ${t.name}`)}catch(a){new o.Notice(`\u5220\u9664\u5931\u8D25: ${a.message}`)}})}),i.addItem(n=>{n.setTitle("\u79FB\u52A8\u6587\u4EF6\u5939").setIcon("arrow-right-circle").onClick(async()=>{this.showFolderSelectionModal(t,async s=>{if(s&&s.path!==t.path)try{if(s.path.startsWith(t.path+"/"))new o.Notice("\u4E0D\u80FD\u5C06\u6587\u4EF6\u5939\u79FB\u52A8\u5230\u5176\u5B50\u6587\u4EF6\u5939\u4E2D");else{let a=s.path?`${s.path}/${t.name}`:t.name;await this.app.fileManager.renameFile(t,a),this.initFolderTree(),new o.Notice(`\u5DF2\u79FB\u52A8\u6587\u4EF6\u5939 ${t.name} \u5230 ${s.name}`)}}catch(a){new o.Notice(`\u79FB\u52A8\u6587\u4EF6\u5939\u5931\u8D25: ${a.message}`),console.error("\u79FB\u52A8\u6587\u4EF6\u5939\u9519\u8BEF:",a)}})})}),i.showAtPosition({x:e.clientX,y:e.clientY})}async executeCustomCommand(e,t){try{if(!this.app.commands.findCommand(e.command)){new o.Notice(`\u627E\u4E0D\u5230\u547D\u4EE4: ${e.name}`);return}this.currentFolder=t,this.app.commands.executeCommandById(e.command),setTimeout(()=>{this.showFolderFiles(t)},500)}catch(i){new o.Notice(`\u6267\u884C\u547D\u4EE4\u5931\u8D25: ${i.message}`),console.error("\u6267\u884C\u81EA\u5B9A\u4E49\u547D\u4EE4\u9519\u8BEF:",i)}}isFileBookmarked(e){try{let t=this.app.internalPlugins.plugins.bookmarks;if(!t||!t.enabled)return!1;let i=t.instance,n=[];if(i.items)n=i.items;else if(typeof i.getItems=="function")n=i.getItems();else return console.log("\u65E0\u6CD5\u83B7\u53D6\u4E66\u7B7E\u5217\u8868"),!1;return n.some(s=>s.type==="file"&&s.path===e.path)}catch(t){return console.error("\u68C0\u67E5\u4E66\u7B7E\u72B6\u6001\u65F6\u51FA\u9519:",t),!1}}toggleBookmark(e){try{let t=this.app.internalPlugins.plugins.bookmarks;if(!t||!t.enabled){new o.Notice("\u4E66\u7B7E\u529F\u80FD\u672A\u542F\u7528");return}let i=this.isFileBookmarked(e),n=t.instance;if(i){if(typeof n.removeItem=="function"){let a=(n.items||[]).find(r=>r.type==="file"&&r.path===e.path);a?n.removeItem(a):n.removeItem({type:"file",path:e.path})}else if(typeof n.removeBookmark=="function"){let a=(n.items||[]).find(r=>r.type==="file"&&r.path===e.path);a?n.removeBookmark(a):n.removeBookmark({type:"file",path:e.path})}else throw new Error("\u65E0\u6CD5\u627E\u5230\u6709\u6548\u7684\u4E66\u7B7E\u79FB\u9664\u65B9\u6CD5");new o.Notice("\u5DF2\u53D6\u6D88\u6536\u85CF")}else{if(typeof n.addItem=="function")n.addItem({type:"file",path:e.path,title:e.basename});else if(typeof n.addBookmark=="function")n.addBookmark({type:"file",path:e.path,title:e.basename});else throw new Error("\u65E0\u6CD5\u627E\u5230\u6709\u6548\u7684\u4E66\u7B7E\u6DFB\u52A0\u65B9\u6CD5");new o.Notice("\u5DF2\u6DFB\u52A0\u5230\u6536\u85CF")}typeof n.trigger=="function"?n.trigger("changed"):typeof n.requestSave=="function"&&n.requestSave()}catch(t){console.error("\u5207\u6362\u4E66\u7B7E\u72B6\u6001\u65F6\u51FA\u9519:",t),new o.Notice("\u64CD\u4F5C\u4E66\u7B7E\u5931\u8D25: "+t.message)}}async createNewNote(){try{let e=this.app.vault.getConfig("newFileLocation"),t;if(e==="folder"){let n=this.app.vault.getConfig("newFileFolderPath"),s=this.app.vault.getAbstractFileByPath(n);s instanceof o.TFolder?t=s:t=this.app.vault.getRoot()}else e==="current"?this.currentFolder?t=this.currentFolder:t=this.app.vault.getRoot():t=this.app.vault.getRoot();let i=await this.promptForName("\u65B0\u7B14\u8BB0\u540D\u79F0");if(i){let n=i.endsWith(".md")?i:`${i}.md`,s=await this.app.vault.create(`${t.path}${t.path?"/":""}${n}`,"");await this.app.workspace.getLeaf().openFile(s),this.currentFolder&&t.path===this.currentFolder.path?(this.showFolderFiles(this.currentFolder),this.highlightOpenedFile(s)):await this.focusOnFile(s),new o.Notice(`\u5DF2\u521B\u5EFA\u5E76\u6253\u5F00\u7B14\u8BB0: ${n}`)}}catch(e){new o.Notice(`\u521B\u5EFA\u7B14\u8BB0\u5931\u8D25: ${e.message}`),console.error("\u521B\u5EFA\u7B14\u8BB0\u5931\u8D25:",e)}}async createRootFolder(){let e=this.app.vault.getRoot(),t=await this.promptForName("\u65B0\u6587\u4EF6\u5939\u540D\u79F0");if(t)try{if(t.match(/[\\/:*?"<>|]/))throw new Error('\u6587\u4EF6\u5939\u540D\u79F0\u4E0D\u80FD\u5305\u542B\u4EE5\u4E0B\u5B57\u7B26: \\ / : * ? " < > |');let i=t;if(this.app.vault.getAbstractFileByPath(i))throw new Error("\u5DF2\u5B58\u5728\u540C\u540D\u6587\u4EF6\u5939\u6216\u6587\u4EF6");await this.app.vault.createFolder(i),this.initFolderTree(),new o.Notice(`\u5DF2\u5728\u6839\u76EE\u5F55\u521B\u5EFA\u6587\u4EF6\u5939: ${t}`)}catch(i){new o.Notice(`\u521B\u5EFA\u6587\u4EF6\u5939\u5931\u8D25: ${i.message}`),console.error("\u521B\u5EFA\u6587\u4EF6\u5939\u9519\u8BEF:",i)}}addNativeFileManagerOptions(e,t){e.addItem(i=>{i.setTitle("\u590D\u5236\u8DEF\u5F84").setIcon("copy").onClick(()=>{navigator.clipboard.writeText(t.path),new o.Notice("\u5DF2\u590D\u5236\u6587\u4EF6\u5939\u8DEF\u5F84\u5230\u526A\u8D34\u677F")})}),e.addItem(i=>{i.setTitle("\u5728\u7CFB\u7EDF\u8D44\u6E90\u7BA1\u7406\u5668\u4E2D\u6253\u5F00").setIcon("folder-open").onClick(()=>{this.openInSystemExplorer(t.path)})})}showFileContextMenu(e,t){let i=new L(this.app);i.addItem(n=>{n.setTitle("\u6253\u5F00").setIcon("file-text").onClick(()=>{this.app.workspace.getLeaf().openFile(t)})}),i.addItem(n=>{n.setTitle("\u65B0\u5EFA Markdown \u6587\u4EF6").setIcon("file-plus").onClick(async()=>{let s=t.parent;s&&await this.createMarkdownFile(s)})}),i.addItem(n=>{n.setTitle("\u5728\u65B0\u6807\u7B7E\u9875\u6253\u5F00").setIcon("file-plus").onClick(()=>{this.app.workspace.getLeaf("tab").openFile(t)})}),i.addItem(n=>{n.setTitle("\u5728\u65B0\u6807\u7B7E\u7EC4\u6253\u5F00").setIcon("split").onClick(()=>{this.app.workspace.getLeaf("split").openFile(t)})}),i.addItem(n=>{n.setTitle("\u5728\u65B0\u7A97\u53E3\u6253\u5F00").setIcon("new-window").onClick(()=>{this.app.workspace.getLeaf("window").openFile(t)})}),i.addItem(n=>{n.setTitle("\u590D\u5236\u8DEF\u5F84").setIcon("copy").onClick(()=>{navigator.clipboard.writeText(t.path),new o.Notice("\u5DF2\u590D\u5236\u6587\u4EF6\u5939\u8DEF\u5F84\u5230\u526A\u8D34\u677F")})}),i.addItem(n=>{n.setTitle("\u521B\u5EFA\u526F\u672C").setIcon("copy").onClick(async()=>{try{let s=t.parent;if(!s)throw new Error("\u65E0\u6CD5\u83B7\u53D6\u6587\u4EF6\u6240\u5728\u6587\u4EF6\u5939");let a=t.basename,r=t.extension,d=`${a} \u526F\u672C`,l=1;for(;this.app.vault.getAbstractFileByPath(`${s.path}/${d}.${r}`);)d=`${a} \u526F\u672C ${l}`,l++;let m=await this.app.vault.read(t),p=await this.app.vault.create(`${s.path}/${d}.${r}`,m);this.currentFolder&&this.showFolderFiles(this.currentFolder),new o.Notice(`\u5DF2\u521B\u5EFA\u6587\u4EF6\u526F\u672C: ${d}.${r}`)}catch(s){new o.Notice(`\u521B\u5EFA\u526F\u672C\u5931\u8D25: ${s.message}`)}})}),this.app.plugins.plugins["better-export-pdf"]&&i.addItem(n=>{n.setTitle("\u5BFC\u51FA\u4E3APDF").setIcon("file-pdf").onClick(async()=>{try{await this.app.workspace.getLeaf().openFile(t),await this.app.commands.executeCommandById("better-export-pdf:export-current-file-to-pdf"),new o.Notice(`\u6B63\u5728\u5BFC\u51FA ${t.name} \u4E3APDF`)}catch(s){new o.Notice(`\u5BFC\u51FAPDF\u5931\u8D25: ${s.message}`),console.error("\u5BFC\u51FAPDF\u9519\u8BEF:",s)}})}),i.addItem(n=>{n.setTitle("\u67E5\u770B\u6587\u4EF6\u5386\u53F2").setIcon("copy").onClick(async()=>{try{await this.app.commands.executeCommandById("file-recovery:open-recovery-folder"),setTimeout(async()=>{await this.app.commands.executeCommandById("file-recovery:recover-file")},100),new o.Notice(`\u6B63\u5728\u52A0\u8F7D ${t.name} \u7684\u5386\u53F2\u7248\u672C`)}catch(s){new o.Notice(`\u52A0\u8F7D\u6587\u4EF6\u5386\u53F2\u5931\u8D25: ${s.message}`),console.error("\u52A0\u8F7D\u6587\u4EF6\u5386\u53F2\u9519\u8BEF:",s)}})}),i.addItem(n=>{n.setTitle("\u79FB\u52A8\u6587\u4EF6").setIcon("split").onClick(()=>{this.currentFolder?this.showFolderSelectionModal(this.currentFolder,async s=>{s&&await this.moveFilesToFolder([t],s)}):new o.Notice("\u8BF7\u5148\u9009\u62E9\u4E00\u4E2A\u6587\u4EF6\u5939")})}),i.addItem(n=>{n.setTitle("\u79FB\u52A8\u6587\u4EF6(\u547D\u4EE4)").setIcon("split").onClick(async()=>{await this.app.commands.executeCommandById("file-explorer:move-file")})}),this.app.plugins.plugins["obsidian-mindmap-nextgen"]&&i.addItem(n=>{n.setTitle("\u6253\u5F00\u4E3A\u601D\u7EF4\u5BFC\u56FE").setIcon("git-branch").onClick(async()=>{try{await this.app.workspace.getLeaf().openFile(t),await this.app.commands.executeCommandById("obsidian-mindmap-nextgen:mindmapnextgen:unpinned")}catch(s){new o.Notice(`\u6253\u5F00\u601D\u7EF4\u5BFC\u56FE\u5931\u8D25: ${s.message}`),console.error("\u6253\u5F00\u601D\u7EF4\u5BFC\u56FE\u9519\u8BEF:",s)}})}),this.app.plugins.plugins["copy-document-as-html"]&&i.addItem(n=>{n.setTitle("\u590D\u5236\u4E3A HTML").setIcon("copy").onClick(async()=>{try{await this.app.workspace.getLeaf().openFile(t),await this.app.commands.executeCommandById("copy-document-as-html:copy-as-html"),new o.Notice(`\u5DF2\u590D\u5236 ${t.name} \u4E3A HTML`)}catch(s){new o.Notice(`\u590D\u5236\u4E3A HTML \u5931\u8D25: ${s.message}`),console.error("\u590D\u5236\u4E3A HTML \u9519\u8BEF:",s)}})}),this.app.plugins.plugins["obsidian-hover-editor"]&&i.addItem(n=>{n.setTitle("\u6253\u5F00 hover").setIcon("copy").onClick(async()=>{try{await this.app.commands.executeCommandById("obsidian-hover-editor:open-current-file-in-new-popover")}catch(s){new o.Notice(`\u6253\u5F00 hover \u5931\u8D25: ${s.message}`),console.error("\u6253\u5F00 hover \u9519\u8BEF:",s)}})}),i.addItem(n=>{let s=this.isFileBookmarked(t);n.setTitle(s?"\u53D6\u6D88\u6536\u85CF":"\u6536\u85CF").setIcon(s?"star-off":"star").onClick(()=>{this.toggleBookmark(t)})}),i.addItem(n=>{n.setTitle("\u5728\u7CFB\u7EDF\u8D44\u6E90\u7BA1\u7406\u5668\u4E2D\u6253\u5F00").setIcon("folder-open").onClick(()=>{this.openInSystemExplorer(t.path)})}),i.addItem(n=>{n.setTitle("\u91CD\u547D\u540D").setIcon("pencil").onClick(async()=>{let s=t.name;t.extension==="md"&&(s=t.basename);let a=await this.promptForName("\u91CD\u547D\u540D\u6587\u4EF6",s);if(a&&a!==s)try{let r=t.parent?t.parent.path+"/":"",d=a;t.extension&&!d.endsWith(`.${t.extension}`)&&(d=`${d}.${t.extension}`),await this.app.fileManager.renameFile(t,`${r}${d}`),this.showFolderFiles(this.currentFolder),new o.Notice(`\u5DF2\u91CD\u547D\u540D\u6587\u4EF6\u4E3A: ${d}`)}catch(r){new o.Notice(`\u91CD\u547D\u540D\u5931\u8D25: ${r.message}`)}})}),i.addItem(n=>{n.setTitle("\u5220\u9664").setIcon("trash").onClick(async()=>{if(await this.confirmDelete(`\u786E\u5B9A\u8981\u5220\u9664\u6587\u4EF6 "${t.name}" \u5417\uFF1F`))try{await this.app.vault.trash(t,!0),this.showFolderFiles(this.currentFolder),new o.Notice(`\u5DF2\u5C06\u6587\u4EF6\u79FB\u52A8\u5230\u56DE\u6536\u7AD9: ${t.name}`)}catch(a){new o.Notice(`\u5220\u9664\u5931\u8D25: ${a.message}`)}})}),i.showAtPosition({x:e.clientX,y:e.clientY})}openInSystemExplorer(e){var i,n;let t="";try{if(t=((n=(i=this.app.vault.adapter).getBasePath)==null?void 0:n.call(i))||"",!t){let a=this.app.vault.configDir;a&&(t=a.replace(/[\/\\]\.obsidian$/,""))}if(!t)throw new Error("\u65E0\u6CD5\u786E\u5B9A\u5E93\u7684\u6839\u8DEF\u5F84");let s=require("path").join(t,e);require("electron").shell.showItemInFolder(s),new o.Notice(`\u5DF2\u5728\u7CFB\u7EDF\u8D44\u6E90\u7BA1\u7406\u5668\u4E2D\u6253\u5F00: ${e}`)}catch(s){new o.Notice(`\u65E0\u6CD5\u6253\u5F00\u8DEF\u5F84: ${s.message}`),console.error("\u6253\u5F00\u7CFB\u7EDF\u8D44\u6E90\u7BA1\u7406\u5668\u5931\u8D25:",s,"\u57FA\u7840\u8DEF\u5F84:",t)}}addPluginCreateOptions(e,t){var i;this.app.plugins.plugins["obsidian-kanban"]&&e.addItem(n=>{n.setTitle("\u65B0\u5EFA\u770B\u677F").setIcon("layout-kanban").onClick(async()=>{let s=await this.promptForName("\u65B0\u770B\u677F\u540D\u79F0");if(s)try{let a=s.endsWith(".md")?s:`${s}.md`;await this.app.vault.create(`${t.path}/${a}`,`---
kanban-plugin: basic
---

## \u5F85\u529E

- [ ] \u4EFB\u52A11

## \u8FDB\u884C\u4E2D

## \u5DF2\u5B8C\u6210

`),this.showFolderFiles(t),new o.Notice(`\u5DF2\u521B\u5EFA\u770B\u677F: ${a}`)}catch(a){new o.Notice(`\u521B\u5EFA\u770B\u677F\u5931\u8D25: ${a.message}`)}})}),(i=this.app.internalPlugins.plugins.canvas)!=null&&i.enabled&&e.addItem(n=>{n.setTitle("\u65B0\u5EFA Canvas").setIcon("layout-grid").onClick(async()=>{let s=await this.promptForName("\u65B0 Canvas \u540D\u79F0");if(s)try{let a=s.endsWith(".canvas")?s:`${s}.canvas`;await this.app.vault.create(`${t.path}/${a}`,JSON.stringify({nodes:[],edges:[]})),this.showFolderFiles(t),new o.Notice(`\u5DF2\u521B\u5EFA Canvas: ${a}`)}catch(a){new o.Notice(`\u521B\u5EFA Canvas \u5931\u8D25: ${a.message}`)}})}),this.app.plugins.plugins["obsidian-excalidraw-plugin"]&&e.addItem(n=>{n.setTitle("\u65B0\u5EFA Excalidraw").setIcon("pencil-line").onClick(async()=>{let s=await this.promptForName("\u65B0 Excalidraw \u540D\u79F0");if(s)try{let a=s.endsWith(".md")?s:`${s}.md`;await this.app.vault.create(`${t.path}/${a}`,`---
excalidraw-plugin: raw
---

==\u26A0  Switch to EXCALIDRAW VIEW in the MORE OPTIONS menu of this document. \u26A0==`),this.showFolderFiles(t),new o.Notice(`\u5DF2\u521B\u5EFA Excalidraw: ${a}`)}catch(a){new o.Notice(`\u521B\u5EFA Excalidraw \u5931\u8D25: ${a.message}`)}})}),this.app.plugins.plugins["obsidian-mindmap-nextgen"]&&e.addItem(n=>{n.setTitle("\u65B0\u5EFA\u601D\u7EF4\u5BFC\u56FE").setIcon("git-branch").onClick(async()=>{let s=await this.promptForName("\u65B0\u601D\u7EF4\u5BFC\u56FE\u540D\u79F0");if(s)try{let a=s.endsWith(".md")?s:`${s}.md`;await this.app.vault.create(`${t.path}/${a}`,`---
mindmap-plugin: basic
---

# \u4E2D\u5FC3\u4E3B\u9898

## \u4E3B\u9898 1

### \u5B50\u4E3B\u9898 1.1

### \u5B50\u4E3B\u9898 1.2

## \u4E3B\u9898 2

### \u5B50\u4E3B\u9898 2.1

### \u5B50\u4E3B\u9898 2.2`),this.showFolderFiles(t),new o.Notice(`\u5DF2\u521B\u5EFA\u601D\u7EF4\u5BFC\u56FE: ${a}`)}catch(a){new o.Notice(`\u521B\u5EFA\u601D\u7EF4\u5BFC\u56FE\u5931\u8D25: ${a.message}`)}})})}showSortMenu(){let e=new L(this.app),t=(i,n,s)=>{let a=this.currentSortCriteria===n&&this.currentSortOrder===s;e.addItem(r=>{r.setTitle(a?`\u2713 ${i}`:i).onClick(()=>{this.currentSortCriteria=n,this.currentSortOrder=s,this.plugin.settings.defaultSortCriteria=n,this.plugin.settings.defaultSortOrder=s,this.plugin.saveSettings(),this.currentFolder&&this.showFolderFiles(this.currentFolder)})})};t("\u6309\u540D\u79F0 (\u5347\u5E8F)","name","asc"),t("\u6309\u540D\u79F0 (\u964D\u5E8F)","name","desc"),t("\u6309\u521B\u5EFA\u65F6\u95F4 (\u6700\u65B0)","ctime","desc"),t("\u6309\u521B\u5EFA\u65F6\u95F4 (\u6700\u65E7)","ctime","asc"),t("\u6309\u4FEE\u6539\u65F6\u95F4 (\u6700\u65B0)","mtime","desc"),t("\u6309\u4FEE\u6539\u65F6\u95F4 (\u6700\u65E7)","mtime","asc"),e.showAtPosition({x:this.sortButton.getBoundingClientRect().left,y:this.sortButton.getBoundingClientRect().bottom})}naturalSort(e,t){return new Intl.Collator("zh-CN",{numeric:!0,sensitivity:"base"}).compare(e,t)}sortFilesArray(e,t,i){e.sort((n,s)=>{let a=0;return t==="name"?a=this.naturalSort(n.name,s.name):t==="ctime"?a=n.stat.ctime-s.stat.ctime:t==="mtime"&&(a=n.stat.mtime-s.stat.mtime),i==="asc"?a:-a})}sortFiles(e,t){this.currentFolder&&(this.currentSortCriteria=e,this.currentSortOrder=t,this.plugin.settings.defaultSortCriteria=e,this.plugin.settings.defaultSortOrder=t,this.plugin.saveSettings(),this.showFolderFiles(this.currentFolder))}handleSearch(){let e=this.searchInput.value.toLowerCase();if(!e){this.currentFolder&&this.showFolderFiles(this.currentFolder);return}this.fileContainer.empty();let t=this.fileContainer.createEl("div",{cls:"file-manager-file-header"});t.textContent=`\u641C\u7D22\u7ED3\u679C: "${e}"`;let i=this.fileContainer.createEl("div",{cls:"file-manager-file-list"}),s=this.getAllFiles().filter(a=>a.name.toLowerCase().includes(e));this.sortFilesArray(s,this.currentSortCriteria,this.currentSortOrder),s.forEach(a=>{this.createFileElement(a,i)})}getAllFiles(){let e=[],t=i=>{i.children.forEach(n=>{n instanceof o.TFile&&!this.isIgnoredFile(n.path)?e.push(n):n instanceof o.TFolder&&!this.isIgnoredFolder(n.path)&&t(n)})};return t(this.app.vault.getRoot()),e}collapseAllFolders(){let e=this.folderContainer.querySelectorAll(".file-manager-folder-children"),t=this.folderContainer.querySelectorAll(".file-manager-collapse-icon");e.forEach(i=>{i.style.display="none"}),t.forEach(i=>{i.innerHTML="\u25B6"})}expandAllFolders(){let e=this.folderContainer.querySelectorAll(".file-manager-folder-children"),t=this.folderContainer.querySelectorAll(".file-manager-collapse-icon");e.forEach(i=>{i.style.display="block"}),t.forEach(i=>{i.innerHTML="\u25BC"}),this.loadAllFolderContents()}loadAllFolderContents(){let e=t=>{t.children.forEach(i=>{i instanceof o.TFolder&&!this.isIgnoredFolder(i.path)&&e(i)})};e(this.app.vault.getRoot())}countFiles(e){let t=0,i=this.plugin.settings.countedFileTypes.split(",").map(s=>s.trim().toLowerCase()),n=s=>{s.children.forEach(a=>{a instanceof o.TFile&&i.includes(a.extension.toLowerCase())?t++:a instanceof o.TFolder&&!this.isIgnoredFolder(a.path)&&n(a)})};return n(e),t}isIgnoredFolder(e){return this.plugin.settings.ignoredFolders.split(",").map(i=>i.trim()).some(i=>{try{return new RegExp(i).test(e)}catch(n){return e.includes(i)}})}isIgnoredFile(e){let t=this.plugin.settings.ignoredExtensions.split(",").map(n=>n.trim()),i=e.split(".").pop();return i?t.includes(i.toLowerCase()):!1}getFileIcon(e){return e.extension==="md"?"\u{1F4C4}":["png","jpg","jpeg","gif","svg"].includes(e.extension)?"\u{1F5BC}\uFE0F":["mp3","wav","ogg"].includes(e.extension)?"\u{1F3B5}":["mp4","webm","mov"].includes(e.extension)?"\u{1F3AC}":["pdf"].includes(e.extension)?"\u{1F4D1}":"\u{1F4C4}"}async promptForName(e,t=""){return new Promise(i=>{new H(this.app,e,t,s=>{i(s)}).open()})}async focusOnFile(e){if(!e)return;let t=e.parent?e.parent.path:"";await this.focusOnFolder(t),this.highlightOpenedFile(e)}async focusOnFolder(e){if(!e)return;let t=e.split("/").filter(s=>s.length>0),i="";for(let s of t)i+=(i?"/":"")+s,await this.expandFolder(i);let n=document.querySelectorAll(`.file-manager-folder-title[data-path="${e}"]`);if(n.length>0){let s=n[0];s.scrollIntoView({behavior:"smooth",block:"center"}),s.click()}}async expandFolder(e){var i;let t=document.querySelectorAll(`.file-manager-folder-title[data-path="${e}"]`);if(t.length>0){let n=t[0],s=(i=n.parentElement)==null?void 0:i.querySelector(".file-manager-folder-children"),a=n.querySelector(".file-manager-collapse-icon");if(s&&s.style.display==="none"){s.style.display="block",a&&(a.innerHTML="\u25BC");let r=this.app.vault.getAbstractFileByPath(e);r instanceof o.TFolder&&this.loadFolderContents(r)}}}async confirmDelete(e){return new Promise(t=>{new M(this.app,e+`

\u6587\u4EF6\u5C06\u88AB\u79FB\u52A8\u5230\u7CFB\u7EDF\u56DE\u6536\u7AD9\uFF0C\u53EF\u4EE5\u5728\u9700\u8981\u65F6\u6062\u590D\u3002`,()=>t(!0),()=>t(!1)).open()})}},H=class extends o.Modal{constructor(e,t,i,n){super(e);this.onSubmit=n,this.initialValue=i,this.titleText=t}onOpen(){let{contentEl:e}=this;e.createEl("h2",{text:this.titleText});let t=e.createEl("input",{type:"text",value:this.initialValue});t.addClass("file-manager-name-input"),t.select();let i=e.createEl("div",{cls:"file-manager-modal-button-container"}),n=i.createEl("button",{text:"\u786E\u5B9A",cls:"mod-cta"}),s=i.createEl("button",{text:"\u53D6\u6D88"}),a=()=>{this.result=t.value,this.close(),this.onSubmit(this.result)};n.addEventListener("click",a),s.addEventListener("click",()=>this.close()),t.addEventListener("keydown",r=>{r.key==="Enter"&&a()})}onClose(){let{contentEl:e}=this;e.empty(),this.result||this.onSubmit("")}},M=class extends o.Modal{constructor(e,t,i,n){super(e);this.message=t,this.onConfirm=i,this.onCancel=n}onOpen(){let{contentEl:e}=this;e.createEl("p",{text:this.message});let t=e.createEl("div",{cls:"file-manager-modal-button-container"}),i=t.createEl("button",{text:"\u786E\u5B9A",cls:"mod-warning"}),n=t.createEl("button",{text:"\u53D6\u6D88"});i.addEventListener("click",()=>{this.close(),this.onConfirm()}),n.addEventListener("click",()=>{this.close(),this.onCancel()})}onClose(){let{contentEl:e}=this;e.empty()}},S=class{constructor(h){this.items=[];this.outsideClickHandler=h=>{this.element.contains(h.target)||this.hide()};this.app=h,this.element=document.createElement("div"),this.element.addClass("file-manager-menu"),this.element.style.position="absolute",this.element.style.zIndex="1000",this.element.style.backgroundColor="var(--background-primary)",this.element.style.border="1px solid var(--background-modifier-border)",this.element.style.borderRadius="4px",this.element.style.boxShadow="0 2px 8px rgba(0, 0, 0, 0.2)",this.element.style.overflow="hidden",this.element.style.minWidth="180px"}addItem(h){let e=new $(this.app);return h(e),this.items.push(e),this}addSeparator(){let h=new $(this.app);return h.setIsSeparator(!0),this.items.push(h),this}showAtPosition(h){S.activeMenu&&S.activeMenu!==this&&S.activeMenu.hide(),S.activeMenu=this,this.element.empty(),this.items.forEach(i=>{if(i.isSeparator){let a=this.element.createEl("div",{cls:"file-manager-menu-separator"});a.style.height="1px",a.style.margin="5px 0",a.style.backgroundColor="var(--background-modifier-border)";return}let n=this.element.createEl("div",{cls:"file-manager-menu-item"});if(n.style.padding="6px 12px",n.style.cursor="pointer",n.style.display="flex",n.style.alignItems="center",n.style.transition="background-color 0.1s ease",i.icon){let a=n.createEl("span",{cls:"file-manager-menu-icon"});a.innerHTML=i.icon,a.style.marginRight="8px",a.style.width="16px",a.style.textAlign="center"}let s=n.createEl("span",{cls:"file-manager-menu-title"});s.textContent=i.title,n.addEventListener("mouseover",()=>{n.style.backgroundColor="var(--background-modifier-hover)"}),n.addEventListener("mouseout",()=>{n.style.backgroundColor=""}),n.addEventListener("click",()=>{this.hide(),i.clickHandler()})}),document.body.appendChild(this.element);let{x:e,y:t}=h;this.element.style.left=`${e}px`,this.element.style.top=`${t}px`,setTimeout(()=>{let i=this.element.getBoundingClientRect(),n=window.innerWidth,s=window.innerHeight;i.right>n&&(this.element.style.left=`${n-i.width-10}px`),i.bottom>s&&(this.element.style.top=`${s-i.height-10}px`)},0),setTimeout(()=>{document.addEventListener("click",this.outsideClickHandler)},0)}hide(){this.element.remove(),document.removeEventListener("click",this.outsideClickHandler)}},L=S;L.activeMenu=null;var $=class{constructor(h){this.title="";this.icon="";this.clickHandler=()=>{};this.isSeparator=!1;this.app=h}setTitle(h){return this.title=h,this}setIsSeparator(h){return this.isSeparator=h,this}setIcon(h){let e={"folder-plus":"\u{1F4C1}","file-plus":"\u{1F4C4}",pencil:"\u270F\uFE0F",trash:"\u{1F5D1}\uFE0F","file-text":"\u{1F4C4}",star:"\u{1F3F7}\uFE0F","star-off":"\u{1F3F7}\uFE0F","folder-open":"\u{1F4C2}","layout-kanban":"\u{1F4CB}",copy:"\u{1F4CB}","arrow-right-circle":"\u27A1\uFE0F",command:"\u2328\uFE0F","code-glyph":"{ }","git-branch":"\u{1F531}","layout-grid":"\u{1F532}","pencil-line":"\u270F\uFE0F","file-pdf":"\u{1F4D2}","new-window":"\u{1FA9F}",split:"\u{1F500}"};return this.icon=e[h]||h,this}onClick(h){return this.clickHandler=h,this}setSubmenu(){return this}addItem(h){return this}},P=class extends o.PluginSettingTab{constructor(e,t){super(e,t);this.plugin=t}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"\u6587\u4EF6\u7BA1\u7406\u5668\u8BBE\u7F6E"}),e.createEl("h3",{text:"\u81EA\u5B9A\u4E49\u6587\u4EF6\u5939\u547D\u4EE4"});let t=e.createEl("p",{text:"\u6DFB\u52A0\u81EA\u5B9A\u4E49\u547D\u4EE4\u5230\u6587\u4EF6\u5939\u53F3\u952E\u83DC\u5355\u3002\u8FD9\u4E9B\u547D\u4EE4\u5C06\u5728\u9009\u4E2D\u7684\u6587\u4EF6\u5939\u4E0A\u4E0B\u6587\u4E2D\u6267\u884C\u3002"});t.style.marginBottom="1em";let i=e.createEl("button",{text:"\u6DFB\u52A0\u547D\u4EE4",cls:"mod-cta"});i.style.marginBottom="1em",i.addEventListener("click",()=>{this.showCommandPicker()}),this.commandListEl=e.createEl("div",{cls:"file-manager-command-list"}),this.commandListEl.style.border="1px solid var(--background-modifier-border)",this.commandListEl.style.borderRadius="4px",this.commandListEl.style.padding="0.5em",this.commandListEl.style.marginBottom="1em",this.renderCommandList(),new o.Setting(e).setName("\u542F\u52A8\u65F6\u81EA\u52A8\u6253\u5F00").setDesc("\u542F\u52A8 Obsidian \u65F6\u81EA\u52A8\u6253\u5F00\u6587\u4EF6\u7BA1\u7406\u5668\u89C6\u56FE").addToggle(n=>n.setValue(this.plugin.settings.autoOpen).onChange(async s=>{this.plugin.settings.autoOpen=s,await this.plugin.saveSettings()})),new o.Setting(e).setName("\u6587\u4EF6\u547D\u540D\u65B9\u5F0F").setDesc("\u9009\u62E9\u521B\u5EFA\u65B0\u6587\u4EF6\u65F6\u7684\u547D\u540D\u65B9\u5F0F").addDropdown(n=>{n.addOption("manual","\u624B\u52A8\u586B\u5199\u6587\u4EF6\u540D").addOption("auto","\u81EA\u52A8\u547D\u540D (YYYY-MM-DD-HHMMSS)").setValue(this.plugin.settings.fileNamingMethod).onChange(async s=>{this.plugin.settings.fileNamingMethod=s,await this.plugin.saveSettings()})}),new o.Setting(e).setName("\u5FFD\u7565\u7684\u6587\u4EF6\u5939").setDesc("\u4EE5\u9017\u53F7\u5206\u9694\u7684\u6587\u4EF6\u5939\u5217\u8868\uFF0C\u652F\u6301\u6B63\u5219\u8868\u8FBE\u5F0F").addTextArea(n=>n.setValue(this.plugin.settings.ignoredFolders).onChange(async s=>{this.plugin.settings.ignoredFolders=s,await this.plugin.saveSettings()})).setClass("file-manager-setting-textarea"),new o.Setting(e).setName("\u7EDF\u8BA1\u6587\u4EF6\u7C7B\u578B").setDesc("\u4EE5\u9017\u53F7\u5206\u9694\u7684\u6587\u4EF6\u6269\u5C55\u540D\u5217\u8868\uFF0C\u7528\u4E8E\u7EDF\u8BA1\u6587\u4EF6\u5939\u4E2D\u7684\u6587\u4EF6\u6570\u91CF").addTextArea(n=>n.setValue(this.plugin.settings.countedFileTypes).onChange(async s=>{this.plugin.settings.countedFileTypes=s,await this.plugin.saveSettings(),this.app.workspace.getLeavesOfType(v).forEach(r=>{r.view instanceof C&&r.view.initFolderTree()})})).setClass("file-manager-setting-textarea"),new o.Setting(e).setName("\u5FFD\u7565\u7684\u6587\u4EF6\u6269\u5C55\u540D").setDesc("\u4EE5\u9017\u53F7\u5206\u9694\u7684\u6587\u4EF6\u6269\u5C55\u540D\u5217\u8868\uFF0C\u652F\u6301\u6B63\u5219\u8868\u8FBE\u5F0F").addTextArea(n=>n.setValue(this.plugin.settings.ignoredExtensions).onChange(async s=>{this.plugin.settings.ignoredExtensions=s,await this.plugin.saveSettings()})).setClass("file-manager-setting-textarea"),new o.Setting(e).setName("\u6587\u4EF6\u5939\u540D\u79F0\u6700\u5927\u5BBD\u5EA6").setDesc("\u8BBE\u7F6E\u6587\u4EF6\u5939\u540D\u79F0\u7684\u6700\u5927\u663E\u793A\u5BBD\u5EA6 (\u50CF\u7D20)").addSlider(n=>n.setLimits(50,300,10).setValue(this.plugin.settings.folderNameMaxWidth).setDynamicTooltip().onChange(async s=>{this.plugin.settings.folderNameMaxWidth=s,await this.plugin.saveSettings(),this.app.workspace.getLeavesOfType(v).forEach(r=>{r.view instanceof C&&r.view.updateFolderNameStyles()})})),new o.Setting(e).setName("\u6587\u4EF6\u5939\u9762\u677F\u5BBD\u5EA6").setDesc("\u8BBE\u7F6E\u6587\u4EF6\u5939\u9762\u677F\u7684\u5BBD\u5EA6 (\u50CF\u7D20)").addSlider(n=>n.setLimits(150,500,10).setValue(this.plugin.settings.folderPaneWidth).setDynamicTooltip().onChange(async s=>{this.plugin.settings.folderPaneWidth=s,await this.plugin.saveSettings(),this.app.workspace.getLeavesOfType(v).forEach(r=>{r.view instanceof C&&(r.view.folderContainer.style.width=`${s}px`)})})),new o.Setting(e).setName("\u9ED8\u8BA4\u6392\u5E8F\u65B9\u5F0F").setDesc("\u8BBE\u7F6E\u6587\u4EF6\u5217\u8868\u7684\u9ED8\u8BA4\u6392\u5E8F\u65B9\u5F0F").addDropdown(n=>{n.addOption("name-asc","\u6309\u540D\u79F0 (\u5347\u5E8F)").addOption("name-desc","\u6309\u540D\u79F0 (\u964D\u5E8F)").addOption("ctime-desc","\u6309\u521B\u5EFA\u65F6\u95F4 (\u6700\u65B0)").addOption("ctime-asc","\u6309\u521B\u5EFA\u65F6\u95F4 (\u6700\u65E7)").addOption("mtime-desc","\u6309\u4FEE\u6539\u65F6\u95F4 (\u6700\u65B0)").addOption("mtime-asc","\u6309\u4FEE\u6539\u65F6\u95F4 (\u6700\u65E7)").setValue(`${this.plugin.settings.defaultSortCriteria}-${this.plugin.settings.defaultSortOrder}`).onChange(async s=>{let[a,r]=s.split("-");this.plugin.settings.defaultSortCriteria=a,this.plugin.settings.defaultSortOrder=r,await this.plugin.saveSettings(),this.app.workspace.getLeavesOfType(v).forEach(l=>{l.view instanceof C&&(l.view.currentSortCriteria=a,l.view.currentSortOrder=r,l.view.currentFolder&&l.view.showFolderFiles(l.view.currentFolder))})})}),new o.Setting(e).setName("\u91CD\u8F7D\u6587\u4EF6\u6811").setDesc("\u5237\u65B0\u6587\u4EF6\u7BA1\u7406\u5668\u89C6\u56FE").addButton(n=>n.setButtonText("\u91CD\u8F7D").setCta().onClick(()=>{this.app.workspace.getLeavesOfType(v).forEach(a=>{a.view instanceof C&&(a.view.initFolderTree(),new o.Notice("\u6587\u4EF6\u6811\u5DF2\u91CD\u8F7D"))})})),new o.Setting(e).setName("\u663E\u793A\u6587\u4EF6\u5939\u5C55\u5F00/\u6298\u53E0\u56FE\u6807").setDesc("\u662F\u5426\u663E\u793A\u6587\u4EF6\u5939\u524D\u65B9\u7684\u4E09\u89D2\u5F62\u5C55\u5F00/\u6298\u53E0\u56FE\u6807").addToggle(n=>n.setValue(this.plugin.settings.showFolderToggleIcon).onChange(async s=>{this.plugin.settings.showFolderToggleIcon=s,await this.plugin.saveSettings(),this.app.workspace.getLeavesOfType(v).forEach(r=>{r.view instanceof C&&r.view.initFolderTree()}),new o.Notice("\u5DF2"+(s?"\u663E\u793A":"\u9690\u85CF")+"\u6587\u4EF6\u5939\u5C55\u5F00/\u6298\u53E0\u56FE\u6807")}))}renderCommandList(){if(this.commandListEl.empty(),this.plugin.settings.customCommands.length===0){let e=this.commandListEl.createEl("div",{cls:"file-manager-empty-commands",text:'\u6CA1\u6709\u81EA\u5B9A\u4E49\u547D\u4EE4\u3002\u70B9\u51FB"\u6DFB\u52A0\u547D\u4EE4"\u6309\u94AE\u6DFB\u52A0\u3002'});e.style.padding="1em",e.style.color="var(--text-muted)",e.style.textAlign="center";return}this.plugin.settings.customCommands.forEach((e,t)=>{let i=this.commandListEl.createEl("div",{cls:"file-manager-command-item"});i.style.display="flex",i.style.alignItems="center",i.style.padding="0.5em",i.style.borderBottom=t<this.plugin.settings.customCommands.length-1?"1px solid var(--background-modifier-border)":"none";let n=i.createEl("span",{cls:"file-manager-command-icon"});n.style.marginRight="0.5em",n.style.width="20px",n.style.textAlign="center",n.innerHTML=e.icon||"\u2328\uFE0F";let s=i.createEl("span",{cls:"file-manager-command-name"});s.style.flex="1",s.textContent=e.name;let a=i.createEl("span",{cls:"file-manager-command-id"});a.style.fontSize="0.8em",a.style.color="var(--text-muted)",a.style.marginRight="0.5em",a.textContent=e.command;let r=i.createEl("button",{cls:"file-manager-command-delete"});if(r.style.background="none",r.style.border="none",r.style.cursor="pointer",r.style.color="var(--text-error)",r.innerHTML="\u274C",r.addEventListener("click",async()=>{this.plugin.settings.customCommands.splice(t,1),await this.plugin.saveSettings(),this.renderCommandList()}),t>0){let d=i.createEl("button",{cls:"file-manager-command-up"});d.style.background="none",d.style.border="none",d.style.cursor="pointer",d.innerHTML="\u2B06\uFE0F",d.addEventListener("click",async()=>{let l=this.plugin.settings.customCommands[t];this.plugin.settings.customCommands[t]=this.plugin.settings.customCommands[t-1],this.plugin.settings.customCommands[t-1]=l,await this.plugin.saveSettings(),this.renderCommandList()})}if(t<this.plugin.settings.customCommands.length-1){let d=i.createEl("button",{cls:"file-manager-command-down"});d.style.background="none",d.style.border="none",d.style.cursor="pointer",d.innerHTML="\u2B07\uFE0F",d.addEventListener("click",async()=>{let l=this.plugin.settings.customCommands[t];this.plugin.settings.customCommands[t]=this.plugin.settings.customCommands[t+1],this.plugin.settings.customCommands[t+1]=l,await this.plugin.saveSettings(),this.renderCommandList()})}})}showCommandPicker(){new N(this.app,async t=>{if(t){this.plugin.settings.customCommands||(this.plugin.settings.customCommands=[]);let i=Date.now().toString();this.plugin.settings.customCommands.push({id:i,name:t.name,icon:"\u2328\uFE0F",command:t.id}),await this.plugin.saveSettings(),this.renderCommandList()}}).open()}},N=class extends o.Modal{constructor(e,t){super(e);this.onSelect=t,this.commands=Object.values(this.app.commands.commands).map(i=>({id:i.id,name:i.name})).sort((i,n)=>i.name.localeCompare(n.name))}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:"\u9009\u62E9\u547D\u4EE4"}),this.searchInput=e.createEl("input",{type:"text",placeholder:"\u641C\u7D22\u547D\u4EE4..."}),this.searchInput.style.width="100%",this.searchInput.style.marginBottom="1em",this.searchInput.addEventListener("input",()=>{this.renderResults()}),this.resultContainer=e.createEl("div"),this.resultContainer.style.maxHeight="300px",this.resultContainer.style.overflow="auto",this.resultContainer.style.border="1px solid var(--background-modifier-border)",this.resultContainer.style.borderRadius="4px",this.renderResults(),setTimeout(()=>{this.searchInput.focus()},10)}renderResults(){this.resultContainer.empty();let e=this.searchInput.value.toLowerCase(),t=this.commands;e&&(t=this.commands.filter(n=>n.name.toLowerCase().includes(e)||n.id.toLowerCase().includes(e)));let i=t.slice(0,100);if(i.length===0){let n=this.resultContainer.createEl("div",{text:"\u6CA1\u6709\u627E\u5230\u5339\u914D\u7684\u547D\u4EE4"});n.style.padding="1em",n.style.color="var(--text-muted)",n.style.textAlign="center";return}if(i.forEach(n=>{let s=this.resultContainer.createEl("div",{cls:"command-picker-item"});s.style.padding="0.5em 1em",s.style.cursor="pointer",s.style.borderBottom="1px solid var(--background-modifier-border)",s.style.transition="background-color 0.1s ease";let a=s.createEl("div",{text:n.name});a.style.fontWeight="bold";let r=s.createEl("div",{text:n.id});r.style.fontSize="0.8em",r.style.color="var(--text-muted)",s.addEventListener("mouseover",()=>{s.style.backgroundColor="var(--background-modifier-hover)"}),s.addEventListener("mouseout",()=>{s.style.backgroundColor=""}),s.addEventListener("click",()=>{this.close(),this.onSelect(n)})}),t.length>100){let n=this.resultContainer.createEl("div",{text:`\u663E\u793A\u524D100\u4E2A\u7ED3\u679C\uFF0C\u5171 ${t.length} \u4E2A\u5339\u914D`});n.style.padding="0.5em",n.style.color="var(--text-muted)",n.style.textAlign="center",n.style.fontSize="0.8em"}}onClose(){let{contentEl:e}=this;e.empty()}},O=class extends o.Modal{constructor(e,t,i){super(e);this.selectedFolder=null;this.expandedFolders=new Set;this.sourceFolder=t,this.callback=i}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:"\u9009\u62E9\u76EE\u6807\u6587\u4EF6\u5939"}),e.createEl("p",{text:`\u5C06 "${this.sourceFolder.name}" \u79FB\u52A8\u5230:`});let t=e.createEl("div",{cls:"folder-selection-list"});t.style.maxHeight="300px",t.style.overflow="auto",t.style.border="1px solid var(--background-modifier-border)",t.style.padding="8px",t.style.marginBottom="16px";let i=this.app.vault.getRoot();this.addFolderOption(t,i,0,!0),this.addChildFolders(t,i,1);let n=e.createEl("div",{cls:"folder-selection-buttons"});n.style.display="flex",n.style.justifyContent="flex-end",n.style.gap="8px",n.createEl("button",{text:"\u53D6\u6D88"}).addEventListener("click",()=>{this.close(),this.callback(null)});let a=n.createEl("button",{text:"\u786E\u8BA4",cls:"mod-cta"});a.addEventListener("click",()=>{this.close(),this.callback(this.selectedFolder)}),a.disabled=!0,t.addEventListener("click",r=>{let d=r.target;if(d.hasClass("folder-toggle-icon")){r.stopPropagation();let m=d.closest(".folder-selection-item");if(m){let p=m.getAttribute("data-path");p&&this.toggleFolder(m,p)}return}let l=d.closest(".folder-selection-item");if(l){let m=l.getAttribute("data-path");if(m){let p=this.app.vault.getAbstractFileByPath(m);if(p instanceof o.TFolder){t.querySelectorAll(".folder-selection-selected").forEach(c=>{c.removeClass("folder-selection-selected");let u=c.querySelector(".folder-header");u&&(u.style.backgroundColor="")}),l.addClass("folder-selection-selected");let f=l.querySelector(".folder-header");f&&(f.style.backgroundColor="var(--background-modifier-active)"),this.selectedFolder=p,a.disabled=!1}}}})}toggleFolder(e,t){let i=e.querySelector(".folder-children-container"),n=e.querySelector(".folder-toggle-icon");if(i)if(i.style.display==="none"){if(i.style.display="block",n.textContent="\u25BC",this.expandedFolders.add(t),i.childElementCount===0){let s=this.app.vault.getAbstractFileByPath(t);if(s instanceof o.TFolder){let a=parseInt(e.getAttribute("data-level")||"0")+1;this.addChildFolders(i,s,a)}}}else i.style.display="none",n.textContent="\u25B6",this.expandedFolders.delete(t)}addChildFolders(e,t,i){let n=t.children.filter(s=>s instanceof o.TFolder).sort((s,a)=>s.name.localeCompare(a.name));for(let s of n)s.path===this.sourceFolder.path||s.path.startsWith(this.sourceFolder.path+"/")||this.addFolderOption(e,s,i)}addFolderOption(e,t,i,n=!1){let s=e.createEl("div",{cls:"folder-selection-item"});s.setAttribute("data-path",t.path),s.setAttribute("data-level",i.toString()),s.style.padding="4px 0",s.style.cursor="pointer",s.style.borderRadius="4px",s.style.marginLeft=`${i*16}px`,s.style.display="flex",s.style.alignItems="center",s.style.flexDirection="column";let a=s.createEl("div",{cls:"folder-header"});a.style.display="flex",a.style.alignItems="center",a.style.width="100%",a.style.padding="4px 8px",a.style.borderRadius="4px",a.style.transition="background-color 0.15s ease";let r=a.createEl("input",{type:"checkbox",cls:"folder-selection-checkbox"});r.style.marginRight="8px",r.style.cursor="pointer",r.addEventListener("click",c=>{if(c.stopPropagation(),r.checked){e.querySelectorAll(".folder-selection-checkbox").forEach(y=>{y!==r&&(y.checked=!1)}),e.querySelectorAll(".folder-selection-selected").forEach(y=>{y.removeClass("folder-selection-selected");let E=y.querySelector(".folder-header");E&&(E.style.backgroundColor="")}),s.addClass("folder-selection-selected"),a.style.backgroundColor="var(--background-modifier-active)";let u=this.app.vault.getAbstractFileByPath(s.getAttribute("data-path")||"");if(u instanceof o.TFolder){this.selectedFolder=u;let y=document.querySelector(".folder-selection-buttons button.mod-cta");y&&(y.disabled=!1)}}else{s.removeClass("folder-selection-selected"),a.style.backgroundColor="",this.selectedFolder=null;let u=document.querySelector(".folder-selection-buttons button.mod-cta");u&&(u.disabled=!0)}}),a.addEventListener("mouseover",()=>{s.hasClass("folder-selection-selected")||(a.style.backgroundColor="var(--background-modifier-hover)")}),a.addEventListener("mouseout",()=>{s.hasClass("folder-selection-selected")||(a.style.backgroundColor="")});let d=t.children.some(c=>c instanceof o.TFolder&&c.path!==this.sourceFolder.path&&!c.path.startsWith(this.sourceFolder.path+"/")),l=a.createEl("span",{cls:"folder-toggle-icon"});l.textContent=d?"\u25B6":" ",l.style.width="15px",l.style.marginRight="4px",l.style.cursor="pointer",l.style.display="inline-block",l.style.textAlign="center",d||(l.style.opacity="0.3");let m=a.createEl("span",{cls:"folder-selection-icon"});m.innerHTML="\u{1F4C1}",m.style.marginRight="8px";let p=a.createEl("span",{cls:"folder-selection-name"});p.textContent=n?"\u6839\u76EE\u5F55":t.name;let f=s.createEl("div",{cls:"folder-children-container"});f.style.display="none",f.style.width="100%"}onClose(){let{contentEl:e}=this;e.empty()}};
